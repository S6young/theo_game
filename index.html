<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Theo's Feeding Game! ğŸ§º</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  background: #000;
  font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', cursive;
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
}

/* â”€â”€ GAME CONTAINER â”€â”€ */
#game-container {
  position: relative;
  width: 100vw;
  height: 100vh;
  background: radial-gradient(ellipse at 50% 30%, #2a0050 0%, #0d0030 40%, #000015 100%);
  overflow: hidden;
}

/* â”€â”€ STARS â”€â”€ */
.star {
  position: absolute;
  background: white;
  border-radius: 50%;
  pointer-events: none;
  animation: twinkle var(--dur, 2s) ease-in-out infinite alternate;
}
@keyframes twinkle {
  from { opacity: 0.2; transform: scale(1); }
  to   { opacity: 1;   transform: scale(1.6); }
}

/* â”€â”€ TITLE â”€â”€ */
#title {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  font-size: clamp(22px, 5vw, 46px);
  white-space: nowrap;
  z-index: 10;
  animation: rainbow 3s linear infinite;
  -webkit-text-stroke: 2px rgba(0,0,0,0.4);
}
@keyframes rainbow {
  0%   { color: #ff4444; text-shadow: 0 0 20px #ff4444; }
  16%  { color: #ff9900; text-shadow: 0 0 20px #ff9900; }
  33%  { color: #ffff00; text-shadow: 0 0 20px #ffff00; }
  50%  { color: #44ff44; text-shadow: 0 0 20px #44ff44; }
  66%  { color: #44ffff; text-shadow: 0 0 20px #44ffff; }
  83%  { color: #ff44ff; text-shadow: 0 0 20px #ff44ff; }
  100% { color: #ff4444; text-shadow: 0 0 20px #ff4444; }
}

/* â”€â”€ HUD â”€â”€ */
#score-display {
  position: absolute;
  top: 65px;
  left: 50%;
  transform: translateX(-50%);
  font-size: clamp(18px, 3.5vw, 34px);
  color: #fff;
  text-shadow: 2px 2px 6px #000, 0 0 15px #FFD700;
  z-index: 10;
  white-space: nowrap;
}
#lives-display {
  position: absolute;
  top: 60px;
  right: 16px;
  font-size: clamp(22px, 4vw, 40px);
  z-index: 10;
  text-shadow: 0 0 10px rgba(255,200,100,0.8);
}

/* â”€â”€ GAME AREA â”€â”€ */
#game-area {
  position: absolute;
  top: 110px;
  left: 0; right: 0; bottom: 0;
}

/* â”€â”€ WAVE TIMER â”€â”€ */
#timer-bar-wrap {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 7px;
  z-index: 14;
  pointer-events: none;
}
#timer-bar-fill {
  height: 100%;
  width: 100%;
  background: #44ff88;
  transition: background-color 0.4s;
}
#timer-num {
  position: absolute;
  top: 9px;
  left: 16px;
  font-size: clamp(13px, 2.1vw, 19px);
  color: #aaffcc;
  text-shadow: 1px 1px 4px #000, 0 0 8px rgba(68,255,136,0.5);
  z-index: 14;
  pointer-events: none;
  transition: color 0.3s;
}
#timer-num.warn  { color: #ffdd44; text-shadow: 1px 1px 4px #000, 0 0 8px rgba(255,220,0,0.7); }
#timer-num.urgent{ color: #ff4444; text-shadow: 1px 1px 4px #000, 0 0 10px rgba(255,60,0,0.8); animation: timer-pulse 0.5s ease-in-out infinite alternate; }
@keyframes timer-pulse {
  from { transform: scale(1); }
  to   { transform: scale(1.18); }
}

/* â”€â”€ PLAYER â”€â”€ */
#player {
  position: absolute;
  font-size: clamp(38px, 7vw, 64px);
  transform: translateX(-50%) translateY(-50%);
  z-index: 10;
  filter: drop-shadow(0 0 12px rgba(100,220,255,0.9));
}

/* â”€â”€ FOOD (was bullets) â”€â”€ */
.bullet {
  position: absolute;
  font-size: clamp(26px, 4.5vw, 42px);
  z-index: 8;
  transform: translateX(-50%) translateY(-50%);
  pointer-events: none;
  line-height: 1;
  animation: food-spin 1.5s linear infinite;
  filter: drop-shadow(0 0 6px rgba(255,220,80,0.8));
}
@keyframes food-spin {
  from { transform: translateX(-50%) translateY(-50%) rotate(0deg) scale(1); }
  to   { transform: translateX(-50%) translateY(-50%) rotate(360deg) scale(1.1); }
}

/* â”€â”€ ALIENS â”€â”€ */
.alien {
  position: absolute;
  font-size: clamp(50px, 10vw, 90px);
  transform: translateX(-50%) translateY(-50%);
  z-index: 9;
  line-height: 1;
  filter: drop-shadow(0 0 8px rgba(255,220,100,0.6));
}
.alien.hop {
  animation: hop 0.15s ease-out;
}
@keyframes hop {
  0%   { transform: translateX(-50%) translateY(-50%) scale(1) rotate(0deg); }
  50%  { transform: translateX(-50%) translateY(-60%) scale(1.25) rotate(8deg); }
  100% { transform: translateX(-50%) translateY(-50%) scale(1) rotate(0deg); }
}

/* â”€â”€ BOSS ALIEN â”€â”€ */
.boss {
  transition: font-size 0.3s cubic-bezier(0.34,1.56,0.64,1);
  filter: drop-shadow(0 0 24px rgba(255,210,0,0.95)) drop-shadow(0 0 48px rgba(255,100,0,0.65)) !important;
  animation: boss-float 1.8s ease-in-out infinite alternate !important;
  z-index: 12 !important;
}
@keyframes boss-float {
  from { transform: translateX(-50%) translateY(-50%) scale(1) rotate(-4deg); }
  to   { transform: translateX(-50%) translateY(-62%) scale(1.1) rotate(4deg); }
}

/* â”€â”€ BOSS FULLNESS BAR â”€â”€ */
#boss-bar-wrap {
  position: absolute;
  top: 4px;
  left: 50%;
  transform: translateX(-50%);
  width: min(78vw, 480px);
  z-index: 20;
  display: none;
  text-align: center;
  pointer-events: none;
}
#boss-bar-label {
  font-size: clamp(11px, 1.9vw, 17px);
  color: #FFD700;
  text-shadow: 1px 1px 4px #000;
  margin-bottom: 3px;
  white-space: nowrap;
}
#boss-bar-track {
  width: 100%;
  height: 20px;
  background: rgba(0,0,0,0.55);
  border: 2px solid #FFD700;
  border-radius: 12px;
  overflow: hidden;
}
#boss-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #ff4400, #ffbb00, #ffff44);
  border-radius: 10px;
  transition: width 0.35s ease;
  width: 0%;
}

/* â”€â”€ NOM EFFECT (was explosions) â”€â”€ */
.explosion {
  position: absolute;
  pointer-events: none;
  z-index: 20;
  font-size: clamp(40px, 8vw, 70px);
  transform: translateX(-50%) translateY(-50%);
  animation: nom 0.65s ease-out forwards;
}
@keyframes nom {
  0%   { transform: translateX(-50%) translateY(-50%) scale(0.2) rotate(-10deg); opacity: 1; }
  40%  { transform: translateX(-50%) translateY(-65%) scale(1.7) rotate(10deg);  opacity: 1; }
  100% { transform: translateX(-50%) translateY(-90%) scale(1.2) rotate(0deg);   opacity: 0; }
}

/* â”€â”€ OVERLAY SCREENS â”€â”€ */
.screen {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  text-align: center;
  padding: 24px;
  gap: 16px;
}

#tap-screen    { background: radial-gradient(ellipse at center, #1a0040 0%, #060018 100%); cursor: pointer; }
#start-screen  { background: radial-gradient(ellipse at center, #1a0040 0%, #060018 100%); }
#win-screen    { background: radial-gradient(ellipse at center, #003318 0%, #001008 100%); display: none; }
#lose-screen   { background: radial-gradient(ellipse at center, #220000 0%, #080000 100%); display: none; }

.screen h1 {
  font-size: clamp(32px, 8vw, 76px);
  color: #FFD700;
  -webkit-text-stroke: 2px #FF4500;
  text-shadow: 3px 3px 0 #AA2200, 0 0 40px #FFD700;
  animation: bounce 0.7s ease-in-out infinite alternate;
}
@keyframes bounce {
  from { transform: translateY(0px) rotate(-1deg); }
  to   { transform: translateY(-18px) rotate(1deg); }
}

.screen p {
  font-size: clamp(18px, 3.5vw, 32px);
  color: #fff;
  text-shadow: 1px 1px 4px #000;
  line-height: 1.5;
}
.screen .subtitle {
  font-size: clamp(14px, 2.8vw, 26px);
  color: #aaffcc;
}

.big-emoji {
  font-size: clamp(56px, 12vw, 110px);
  animation: float-spin 2s ease-in-out infinite alternate;
  display: block;
  line-height: 1.2;
}
@keyframes float-spin {
  from { transform: rotate(-10deg) translateY(0px) scale(1); }
  to   { transform: rotate(10deg)  translateY(-22px) scale(1.05); }
}

.play-btn {
  font-size: clamp(22px, 4.5vw, 44px);
  padding: 18px 48px;
  background: linear-gradient(135deg, #FF5500, #FFD700);
  border: 4px solid #fff;
  border-radius: 60px;
  color: #fff;
  font-family: inherit;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(255,140,0,0.6), inset 0 2px 0 rgba(255,255,255,0.3);
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  animation: btn-pulse 1.4s ease-in-out infinite alternate;
  transition: transform 0.08s, box-shadow 0.08s;
}
.play-btn:hover, .play-btn:active {
  transform: scale(1.1) !important;
  box-shadow: 0 12px 36px rgba(255,140,0,0.8), inset 0 2px 0 rgba(255,255,255,0.3);
}
@keyframes btn-pulse {
  from { transform: scale(1); }
  to   { transform: scale(1.06); }
}

/* â”€â”€ PLAYER SELECT BUTTONS â”€â”€ */
.player-btns {
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
  max-width: 420px;
}
.player-btn {
  font-size: clamp(20px, 4vw, 36px);
  padding: 16px 40px;
  border: 4px solid rgba(255,255,255,0.8);
  border-radius: 60px;
  color: #fff;
  font-family: inherit;
  cursor: pointer;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  transition: transform 0.08s, box-shadow 0.08s;
  animation: btn-pulse 1.4s ease-in-out infinite alternate;
}
.player-btn:hover, .player-btn:active {
  transform: scale(1.09) !important;
  box-shadow: 0 12px 36px rgba(0,0,0,0.5);
}
.btn-theo    { background: linear-gradient(135deg, #22bb44, #aaff22); }
.btn-friends { background: linear-gradient(135deg, #2255ee, #aa33ff); }
.btn-adults  { background: linear-gradient(135deg, #cc1100, #ff7700); }

/* â”€â”€ MODE BADGE â”€â”€ */
#mode-badge {
  position: absolute;
  top: 65px;
  left: 16px;
  font-size: clamp(12px, 2vw, 18px);
  color: rgba(255,255,255,0.7);
  z-index: 10;
}

/* â”€â”€ CONFETTI â”€â”€ */
.confetti {
  position: fixed;
  width: 14px;
  height: 14px;
  border-radius: 3px;
  pointer-events: none;
  z-index: 200;
  animation: confetti-fall var(--dur,2s) var(--delay,0s) linear forwards;
}
@keyframes confetti-fall {
  0%   { transform: translateY(-20px) rotate(0deg)   scaleX(1);  opacity: 1; }
  50%  { scaleX(-1); }
  100% { transform: translateY(110vh) rotate(720deg) scaleX(1);  opacity: 0; }
}

/* â”€â”€ NAME ENTRY SCREEN â”€â”€ */
#name-screen {
  background: radial-gradient(ellipse at center, #001a33 0%, #000a18 100%);
  display: none;
}
#name-screen h2 {
  font-size: clamp(26px, 5vw, 52px);
  color: #FFD700;
  text-shadow: 2px 2px 0 #AA6600, 0 0 30px #FFD700;
  margin-bottom: 8px;
}
#name-input {
  font-size: clamp(22px, 4vw, 40px);
  font-family: inherit;
  padding: 14px 24px;
  border-radius: 50px;
  border: 4px solid #FFD700;
  background: rgba(255,255,255,0.1);
  color: #fff;
  text-align: center;
  width: min(90vw, 420px);
  outline: none;
  box-shadow: 0 0 20px rgba(255,215,0,0.3);
}
#name-input::placeholder { color: rgba(255,255,255,0.4); }
.row-btns { display: flex; gap: 14px; flex-wrap: wrap; justify-content: center; }

/* â”€â”€ LEADERBOARD SCREEN â”€â”€ */
#leaderboard-screen {
  background: radial-gradient(ellipse at center, #0a001a 0%, #04000d 100%);
  display: none;
  justify-content: flex-start;
  padding-top: 30px;
  overflow-y: auto;
}
#leaderboard-screen h2 {
  font-size: clamp(28px, 5vw, 54px);
  color: #FFD700;
  text-shadow: 2px 2px 0 #AA6600, 0 0 30px #FFD700;
  margin-bottom: 16px;
}
#lb-table {
  width: min(95vw, 600px);
  border-collapse: collapse;
  margin-bottom: 24px;
  font-size: clamp(13px, 2.4vw, 22px);
}
#lb-table th {
  color: #FFD700;
  border-bottom: 2px solid #FFD700;
  padding: 8px 12px;
  text-align: left;
}
#lb-table td {
  color: #fff;
  padding: 8px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.12);
}
#lb-table tr:first-child td { color: #FFD700; font-size: 1.15em; }
#lb-table tr:nth-child(2) td { color: #cccccc; }
#lb-table tr:nth-child(3) td { color: #cd7f32; }
#lb-loading { color: rgba(255,255,255,0.6); font-size: clamp(16px,3vw,28px); }

/* â”€â”€ WAVE BANNER â”€â”€ */
#wave-banner {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,10,0.9);
  border: 3px solid #FFD700;
  border-radius: 24px;
  padding: 22px 44px;
  text-align: center;
  z-index: 50;
  display: none;
  color: #fff;
  pointer-events: none;
  box-shadow: 0 0 50px rgba(255,215,0,0.35);
}
#wave-banner.visible {
  display: block;
  animation: banner-pop 0.3s ease-out;
}
@keyframes banner-pop {
  from { transform: translate(-50%,-50%) scale(0.5); opacity: 0; }
  to   { transform: translate(-50%,-50%) scale(1);   opacity: 1; }
}
#wave-banner .bt { font-size: clamp(26px,6vw,58px); color: #FFD700; text-shadow: 2px 2px 0 #884400; }
#wave-banner .bs { font-size: clamp(14px,2.8vw,26px); color: #aaffcc; margin-top: 6px; }

/* â”€â”€ COMBO DISPLAY â”€â”€ */
#combo-display {
  position: absolute;
  top: 68px;
  left: 50%;
  transform: translateX(-50%);
  font-size: clamp(15px,2.8vw,26px);
  color: #ff8800;
  text-shadow: 0 0 14px #ff8800, 2px 2px 0 #662200;
  z-index: 10;
  opacity: 0;
  transition: opacity 0.25s;
  pointer-events: none;
  white-space: nowrap;
}

/* â”€â”€ CONTROLS HINT â”€â”€ */
#hint {
  position: absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  font-size: clamp(10px, 1.8vw, 16px);
  color: rgba(255,255,255,0.35);
  z-index: 10;
  white-space: nowrap;
  pointer-events: none;
}

/* â”€â”€ BOSS PHASE 2 (ENRAGED) â”€â”€ */
.boss.phase2 {
  filter: drop-shadow(0 0 30px rgba(255,30,0,1)) drop-shadow(0 0 60px rgba(255,0,50,0.9)) !important;
  animation: boss-rage 0.7s ease-in-out infinite alternate !important;
}
@keyframes boss-rage {
  from { transform: translateX(-50%) translateY(-50%) scale(1.05) rotate(-7deg); }
  to   { transform: translateX(-50%) translateY(-68%) scale(1.2)  rotate(7deg); }
}

/* â”€â”€ BOSS MINIONS â”€â”€ */
.boss-minion {
  filter: drop-shadow(0 0 14px rgba(255,130,30,0.95)) !important;
  animation: boss-float 1.0s ease-in-out infinite alternate !important;
  z-index: 11 !important;
}

/* â”€â”€ MULTI-FEED BULLET â”€â”€ */
.bullet.multi {
  filter: drop-shadow(0 0 14px rgba(255,220,0,1)) drop-shadow(0 0 28px rgba(255,100,0,0.9)) !important;
  animation: food-spin 0.7s linear infinite !important;
  font-size: clamp(32px, 5.5vw, 50px) !important;
}

/* â”€â”€ MULTI-FEED CHARGE DISPLAY â”€â”€ */
#multifeed-display {
  position: absolute;
  top: 90px;
  left: 16px;
  font-size: clamp(12px, 2.1vw, 19px);
  color: #ffdd44;
  text-shadow: 0 0 12px #ffaa00, 2px 2px 0 #664400;
  z-index: 10;
  pointer-events: none;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s;
}
#multifeed-display.charged {
  animation: multifeed-pulse 0.6s ease-in-out infinite alternate;
}
@keyframes multifeed-pulse {
  from { transform: scale(1); }
  to   { transform: scale(1.1); }
}

/* â”€â”€ TOAST NOTIFICATION (streak / events) â”€â”€ */
@keyframes toast-rise {
  0%   { opacity: 1; transform: translateX(-50%) translateY(0)    scale(1.3); }
  25%  { opacity: 1; transform: translateX(-50%) translateY(-8px)  scale(1);   }
  100% { opacity: 0; transform: translateX(-50%) translateY(-55px) scale(0.85); }
}
</style>
</head>
<body>

<!-- â•â•â•â• TAP TO START â•â•â•â• -->
<div class="screen" id="tap-screen" onclick="tapToStart()">
  <span class="big-emoji">ğŸ”Š</span>
  <h1>THEO'S FEEDING GAME!</h1>
  <p class="subtitle">Tap anywhere to start!</p>
</div>

<!-- â•â•â•â• START SCREEN â•â•â•â• -->
<div class="screen" id="start-screen">
  <span class="big-emoji">ğŸ§º</span>
  <h1>THEO'S FEEDING GAME!</h1>
  <p>ğŸ¢ Turtles &amp; Fish are hungry! ğŸ </p>
  <p class="subtitle">Who's playing?</p>
  <div class="player-btns">
    <button class="player-btn btn-theo"    onclick="startGame('theo')">ğŸ‘¦ Theo</button>
    <button class="player-btn btn-friends" onclick="startGame('friends')">ğŸ‘« Theo's Friends</button>
    <button class="player-btn btn-adults"  onclick="startGame('adults')">ğŸ’ª Theo's Adults</button>
    <button class="player-btn" style="background:linear-gradient(135deg,#554400,#aa8800);" onclick="showLeaderboard()">ğŸ† High Scores</button>
  </div>
</div>

<!-- â•â•â•â• WIN SCREEN â•â•â•â• -->
<div class="screen" id="win-screen">
  <h1>YAY THEO! ğŸ‰</h1>
  <span class="big-emoji">ğŸ†</span>
  <p>All animals are fed! AMAZING!!</p>
  <p id="final-score" style="font-size: clamp(24px,5vw,50px); color:#FFD700; text-shadow:0 0 20px #FFD700;"></p>
  <div class="row-btns">
    <button class="play-btn" onclick="showNameEntry()">ğŸ† Save Score</button>
    <button class="play-btn" style="background:linear-gradient(135deg,#333,#666);" onclick="startGame()">ğŸ§º Skip</button>
  </div>
</div>

<!-- â•â•â•â• LOSE SCREEN â•â•â•â• -->
<div class="screen" id="lose-screen">
  <span class="big-emoji" id="lose-emoji">ğŸ˜…</span>
  <h1 id="lose-title">Try Again!</h1>
  <p id="lose-msg">The animals are still hungry, Theo! ğŸŸ</p>
  <div class="row-btns">
    <button class="play-btn" onclick="showNameEntry()">ğŸ† Save Score</button>
    <button class="play-btn" style="background:linear-gradient(135deg,#333,#666);" onclick="startGame()">ğŸ§º Skip</button>
  </div>
</div>

<!-- â•â•â•â• NAME ENTRY SCREEN â•â•â•â• -->
<div class="screen" id="name-screen">
  <span class="big-emoji">âœï¸</span>
  <h2>Who fed the animals?</h2>
  <p class="subtitle" id="name-score-display"></p>
  <input id="name-input" type="text" maxlength="20" placeholder="Type your name..." autocomplete="off" />
  <div class="row-btns">
    <button class="play-btn" onclick="submitScore()">ğŸ† Save!</button>
    <button class="play-btn" style="background:linear-gradient(135deg,#333,#666);" onclick="showLeaderboard()">Skip</button>
  </div>
  <p id="name-error" style="color:#ff8888; font-size:clamp(14px,2.5vw,22px); min-height:1.4em;"></p>
</div>

<!-- â•â•â•â• LEADERBOARD SCREEN â•â•â•â• -->
<div class="screen" id="leaderboard-screen">
  <h2>ğŸ† High Scores</h2>
  <div id="lb-loading">Loading...</div>
  <table id="lb-table" style="display:none;">
    <thead><tr><th>#</th><th>Name</th><th>Score</th><th>Mode</th><th>Date</th></tr></thead>
    <tbody id="lb-body"></tbody>
  </table>
  <div class="row-btns">
    <button class="play-btn" onclick="showScreen('start-screen')">ğŸ§º Play Again</button>
  </div>
</div>

<!-- â•â•â•â• GAME â•â•â•â• -->
<div id="game-container">
  <div id="title">ğŸ§º THEO'S FEEDING GAME! ğŸ§º</div>
  <div id="score-display">ğŸŒŸ Fed: 0</div>
  <div id="lives-display">ğŸ§ºğŸ§ºğŸ§º</div>
  <div id="mode-badge"></div>
  <div id="combo-display"></div>
  <div id="multifeed-display"></div>
  <div id="game-area">
  <div id="wave-banner"></div>
    <div id="timer-bar-wrap"><div id="timer-bar-fill"></div></div>
    <div id="timer-num">â±ï¸ 90</div>
    <div id="boss-bar-wrap">
      <div id="boss-bar-label">ğŸ¦’ Giraffe Fullness: 0%</div>
      <div id="boss-bar-track"><div id="boss-bar-fill"></div></div>
    </div>
    <div id="player">ğŸ§º</div>
    <div id="hint">arrow keys or drag to move &nbsp;|&nbsp; SPACE or tap = throw food!</div>
  </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _ctx = null;
function unlockAudio() {
  if (_ctx) { _ctx.resume(); return; }
  _ctx = new (window.AudioContext || window.webkitAudioContext)();
  // Play a silent buffer â€” required to unlock audio on iOS
  const buf = _ctx.createBuffer(1, 1, 22050);
  const src = _ctx.createBufferSource();
  src.buffer = buf;
  src.connect(_ctx.destination);
  src.start(0);
  _ctx.resume();
}
document.addEventListener('touchstart', unlockAudio, { once: true });
document.addEventListener('click',      unlockAudio, { once: true });

function ac() {
  if (!_ctx) _ctx = new (window.AudioContext || window.webkitAudioContext)();
  if (_ctx.state === 'suspended') _ctx.resume();
  return _ctx;
}
function tone(freq, type, dur, vol, freqEnd) {
  try {
    const c = ac(), o = c.createOscillator(), g = c.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, c.currentTime);
    if (freqEnd) o.frequency.exponentialRampToValueAtTime(freqEnd, c.currentTime + dur);
    g.gain.setValueAtTime(vol, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + dur);
    o.connect(g); g.connect(c.destination);
    o.start(); o.stop(c.currentTime + dur);
  } catch(e){}
}
function sndShoot()   { tone(500,'sine',0.06,0.2,900); setTimeout(()=>tone(700,'sine',0.08,0.15,1100),60); }
function sndHit()     { [880,1047,1319].forEach((n,i)=>setTimeout(()=>tone(n,'sine',0.18,0.3),i*60)); }
function sndLifeLost(){ tone(400,'sine',0.1,0.25,300); setTimeout(()=>tone(280,'sine',0.15,0.2,200),120); }
function sndWin() {
  [523,659,784,1047,1319].forEach((n,i)=>setTimeout(()=>tone(n,'sine',0.35,0.4),i*160));
  setTimeout(()=>[1568,1319,1047,784,1047,1319,1568].forEach((n,i)=>setTimeout(()=>tone(n,'triangle',0.25,0.35),i*120)),900);
}
function sndLose()       { [380,300,240,180,130].forEach((n,i)=>setTimeout(()=>tone(n,'sawtooth',0.25,0.3),i*180)); }
function sndBossHit()    { tone(330,'triangle',0.06,0.22,600); setTimeout(()=>tone(660,'sine',0.1,0.22,1000),75); }
function sndBossDefeat() { [262,330,392,523,659,784,1047,1319].forEach((n,i)=>setTimeout(()=>tone(n,'sine',0.28,0.45),i*110)); }
function sndStreak()     { [523,659,784,1047,1319].forEach((n,i)=>setTimeout(()=>tone(n,'sine',0.22,0.28),i*45)); }
function sndMultiFeed()  { tone(880,'triangle',0.2,0.5,1760); setTimeout(()=>tone(1319,'sine',0.25,0.35),120); }
function sndBossEnrage() { [300,250,200,400,600].forEach((n,i)=>setTimeout(()=>tone(n,'sawtooth',0.3,0.25),i*80)); setTimeout(()=>tone(800,'triangle',0.25,0.4),450); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ROWS = 3;
const COLS = 7;
const MOVE_MS_START = 2000;  // ms between alien steps (gets faster over levels)
const BULLET_SPD  = 3;       // px/frame
const PLAYER_SPD  = 4;       // px/frame keyboard
const SHOOT_CD    = 900;     // ms cooldown between shots
const STEP_X      = 28;      // horizontal alien step
const STEP_Y      = 46;      // vertical alien step when bouncing wall

// emoji layout per row
const ROW_EMOJIS = [
  ['ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢'],
  ['ğŸ ','ğŸ¡','ğŸŸ','ğŸ ','ğŸ¡','ğŸŸ','ğŸ '],
  ['ğŸ¦‘','ğŸ™','ğŸ¦‘','ğŸ™','ğŸ¦‘','ğŸ™','ğŸ¦‘'],
];
const BOOM_EMOJIS  = ['â¤ï¸','ğŸ˜‹','ğŸ¥°','ğŸ˜Š','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ©·'];
const FOOD_EMOJIS  = ['ğŸ','ğŸ¥•','ğŸŸ','ğŸŒ¿','ğŸ“','ğŸ¥¦','ğŸ‡','ğŸŒ½'];
let foodIdx = 0;
const COMBO_WINDOW  = 2500; // ms between hits to keep combo alive
const MAX_WAVES     = 5;    // waves before win in easy/friends mode
const BOSS_WAVE     = 3;    // boss spawns after completing this wave
const BOSS_HP_EASY  = 15;   // hits needed in easy/friends mode
const BOSS_HP_HARD  = 30;   // hits needed in adults mode
const BOSS_PHASE2_PCT     = 0.5;   // HP fraction at which boss enrages in adults mode
const STREAK_WINDOW       = 6000;  // ms between hits to maintain a rapid streak
const STREAK_THRESHOLD    = 5;     // hits in a row to earn one multi-feed charge
const MULTI_FEED_MAX      = 3;     // max multi-feed charges held at once
const MULTI_FOOD_EMOJI    = 'ğŸ•';  // emoji for multi-feed bullets
const TIME_BASE_EASY   = 15;  // seconds for wave 1 (easy/friends)
const TIME_BASE_ADULTS = 15;  // seconds for wave 1 (adults)
const TIME_GROW        = 7;   // extra seconds added per wave
const TIME_BOSS_EASY   = 120; // seconds for boss wave (easy)
const TIME_BOSS_ADULTS = 80;  // seconds for boss wave (adults)
let gameMode = 'theo';
let DIFF = {};

function setDifficulty(mode) {
  if (mode === 'adults') {
    DIFF = { moveNear: 180, moveFar: 900, bulletSpd: 8, shootCd: 400, maxV: 40, changePct: 0.55, initVx: 28, initVy: 22 };
  } else {
    DIFF = { moveNear: 800, moveFar: 3000, bulletSpd: 3, shootCd: 900, maxV: 35, changePct: 0.35, initVx: 30, initVy: 20 };
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let S = {}; // game state
let rafId = null, lastTs = 0, alienTimer = 0;
const keys = {};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initState() {
  const area = document.getElementById('game-area');
  const W = area.clientWidth, H = area.clientHeight;

  // Build alien grid
  const aliens = [];
  const marginX = Math.min(W * 0.12, 60);
  const spacing = (W - marginX*2) / (COLS - 1);
  const startY  = 55;
  const rowH    = Math.min(70, H * 0.11);

  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      aliens.push({
        x:     marginX + c * spacing,
        y:     startY + r * rowH,
        emoji: ROW_EMOJIS[r][c],
        alive: true,
        el:    null,
        vx:    (Math.random() * 2 - 1) * DIFF.initVx,
        vy:    (Math.random() * 2 - 1) * DIFF.initVy,
      });
    }
  }

  S = {
    W, H,
    playerX:   W / 2,
    playerY:   H - 70,
    lives:     3,
    score:     0,
    aliens,
    bullets:   [],
    gameOver:  false,
    won:       false,
    lastShot:  0,
    moveMs:    MOVE_MS_START,
    wave:      1,
    combo:     1,
    comboTimer:null,
    shotsFired: 0,
    shotsHit:   0,
    isBossWave:    false,
    bossHp:        0,
    bossMaxHp:     0,
    bossPhase2:    false,
    bossMinionsSpawned: false,
    streak:           0,
    streakLastHit:    0,
    multiFeedCharge:  0,
    feedStreak:       0,
    feedMilestonesHit: new Set(),
    livesLostThisWave: 0,
    waveStartTime: performance.now(),
    waveTimeLimit: gameMode === 'adults' ? TIME_BASE_ADULTS : TIME_BASE_EASY,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearArea() {
  document.querySelectorAll('.alien,.bullet,.explosion,.confetti').forEach(e=>e.remove());
}

function makeAliens() {
  const area = document.getElementById('game-area');
  S.aliens.forEach(a => {
    const el = document.createElement('div');
    el.className = 'alien';
    el.textContent = a.emoji;
    el.style.left = a.x + 'px';
    el.style.top  = a.y + 'px';
    area.appendChild(el);
    a.el = el;
  });
}

function syncAliens() {
  S.aliens.forEach(a => {
    if (a.alive && a.el) {
      a.el.style.left = a.x + 'px';
      a.el.style.top  = a.y + 'px';
    }
  });
}

function syncPlayer() {
  const p = document.getElementById('player');
  p.style.left = S.playerX + 'px';
  p.style.top  = S.playerY + 'px';
}

function updateHUD() {
  let waveStr;
  if (S.isBossWave) {
    waveStr = 'ğŸ¦’ BOSS!';
  } else {
    waveStr = gameMode === 'adults' ? `Wave ${S.wave}` : `Wave ${S.wave}/${MAX_WAVES}`;
  }
  document.getElementById('score-display').textContent = `ğŸŒŸ ${S.score}  ğŸŒŠ ${waveStr}`;
  document.getElementById('lives-display').textContent = 'ğŸ§º'.repeat(Math.max(0, S.lives));
}
function getWaveTimeLimit(isBoss) {
  if (isBoss) return gameMode === 'adults' ? TIME_BOSS_ADULTS : TIME_BOSS_EASY;
  const base = gameMode === 'adults' ? TIME_BASE_ADULTS : TIME_BASE_EASY;
  return base + (S.wave - 1) * TIME_GROW;
}
function updateTimerDisplay() {
  const elapsed   = (performance.now() - S.waveStartTime) / 1000;
  const remaining = Math.max(0, S.waveTimeLimit - elapsed);
  const pct       = remaining / S.waveTimeLimit * 100;
  const fill = document.getElementById('timer-bar-fill');
  const num  = document.getElementById('timer-num');
  fill.style.width = pct + '%';
  if (pct > 50)      { fill.style.background = '#44ff88'; num.className = ''; }
  else if (pct > 25) { fill.style.background = '#ffdd44'; num.className = 'warn'; }
  else               { fill.style.background = '#ff4444'; num.className = 'urgent'; }
  num.textContent = `â±ï¸ ${Math.ceil(remaining)}s`;
}
function calcTimeBonus() {
  const elapsed    = (performance.now() - S.waveStartTime) / 1000;
  const remaining  = Math.max(0, S.waveTimeLimit - elapsed);
  if (remaining <= 0) return { bonus: 0, secs: 0 };
  const rate  = S.isBossWave ? 15 : (gameMode === 'adults' ? 30 : 20);
  const bonus = Math.floor(remaining) * rate;
  return { bonus, secs: Math.floor(remaining) };
}
function updateComboDisplay() {
  const el = document.getElementById('combo-display');
  if (S.combo > 1) { el.textContent = `ğŸ”¥ COMBO x${S.combo}!`; el.style.opacity = '1'; }
  else             { el.style.opacity = '0'; }
}
function updateMultiFeedDisplay() {
  const el = document.getElementById('multifeed-display');
  const player = document.getElementById('player');
  if (S.multiFeedCharge > 0) {
    el.textContent = `ğŸ• MULTI-FEED ${'âœ¨'.repeat(S.multiFeedCharge)}`;
    el.style.opacity = '1';
    el.classList.add('charged');
    if (player) player.style.filter = 'drop-shadow(0 0 22px rgba(255,220,0,1)) drop-shadow(0 0 44px rgba(255,120,0,0.85))';
  } else {
    el.style.opacity = '0';
    el.classList.remove('charged');
    if (player) player.style.filter = 'drop-shadow(0 0 12px rgba(100,220,255,0.9))';
  }
}
function showGameToast(msg, color) {
  const el = document.createElement('div');
  el.style.cssText = `position:absolute;top:125px;left:50%;transform:translateX(-50%);font-size:clamp(15px,2.8vw,26px);color:${color||'#ff44ff'};text-shadow:0 0 14px currentColor;z-index:15;pointer-events:none;white-space:nowrap;font-family:inherit;animation:toast-rise 1.8s ease-out forwards;`;
  el.textContent = msg;
  document.getElementById('game-container').appendChild(el);
  setTimeout(() => el.remove(), 1800);
}
function dodgeEffect(x, y) {
  const area = document.getElementById('game-area');
  const el = document.createElement('div');
  el.className = 'explosion';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  el.textContent = 'ğŸ˜';
  area.appendChild(el);
  setTimeout(() => el.remove(), 700);
}

const ALL_SCREENS = ['tap-screen','start-screen','win-screen','lose-screen','name-screen','leaderboard-screen'];
function showScreen(id) {
  ALL_SCREENS.forEach(s => {
    document.getElementById(s).style.display = (s === id) ? 'flex' : 'none';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EFFECTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function boom(x, y) {
  const area = document.getElementById('game-area');
  const el = document.createElement('div');
  el.className = 'explosion';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  el.textContent = BOOM_EMOJIS[Math.random()*BOOM_EMOJIS.length|0];
  area.appendChild(el);
  setTimeout(()=>el.remove(), 600);
}

function confetti() {
  const colors = ['#ff4444','#ff9900','#ffff00','#44ff44','#44ffff','#ff44ff','#ff88bb','#aaffaa'];
  for (let i = 0; i < 90; i++) {
    setTimeout(()=>{
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.left = (Math.random()*100) + 'vw';
      el.style.background = colors[Math.random()*colors.length|0];
      el.style.setProperty('--dur',  (1.4 + Math.random()*2.2)+'s');
      el.style.setProperty('--delay','0s');
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 4500);
    }, i * 40);
  }
}

function makeStars() {
  document.querySelectorAll('.star').forEach(s=>s.remove());
  const c = document.getElementById('game-container');
  for (let i = 0; i < 90; i++) {
    const el = document.createElement('div');
    el.className = 'star';
    const sz = Math.random()*2.5+0.8;
    el.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${1+Math.random()*2.5}s;animation-delay:${Math.random()*3}s`;
    c.appendChild(el);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shoot() {
  if (S.gameOver || S.won) return;
  const now = performance.now();
  if (now - S.lastShot < DIFF.shootCd) return;
  S.lastShot = now;

  const area = document.getElementById('game-area');

  // â”€â”€ MULTI-FEED: fire 3 spread bullets
  if (S.multiFeedCharge > 0) {
    S.multiFeedCharge--;
    updateMultiFeedDisplay();
    sndMultiFeed();
    const offsets = [-55, 0, 55];
    offsets.forEach(offset => {
      const mel = document.createElement('div');
      mel.className = 'bullet multi';
      mel.textContent = MULTI_FOOD_EMOJI;
      const bx = Math.max(20, Math.min(S.W - 20, S.playerX + offset));
      const by = S.playerY - 30;
      mel.style.left = bx + 'px';
      mel.style.top  = by + 'px';
      area.appendChild(mel);
      S.bullets.push({ x: bx, y: by, el: mel, isMulti: true });
    });
    S.shotsFired += 3;
    return;
  }

  const el = document.createElement('div');
  el.className = 'bullet';
  el.textContent = FOOD_EMOJIS[foodIdx % FOOD_EMOJIS.length];
  foodIdx++;
  const bx = S.playerX, by = S.playerY - 30;
  el.style.left = bx + 'px';
  el.style.top  = by + 'px';
  area.appendChild(el);
  S.bullets.push({ x: bx, y: by, el });
  S.shotsFired++;
  sndShoot();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME LOOP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loop(ts) {
  if (S.gameOver || S.won) return;
  const dt = Math.min(ts - lastTs, 50); // cap dt so tabbing away doesn't cause issues
  lastTs = ts;

  // â”€â”€ TIMER
  updateTimerDisplay();

  // â”€â”€ PLAYER KEYBOARD MOVEMENT
  if (keys['ArrowLeft']  || keys['a'] || keys['A']) S.playerX -= PLAYER_SPD;
  if (keys['ArrowRight'] || keys['d'] || keys['D']) S.playerX += PLAYER_SPD;
  if (keys['ArrowUp']    || keys['w'] || keys['W']) S.playerY -= PLAYER_SPD;
  if (keys['ArrowDown']  || keys['s'] || keys['S']) S.playerY += PLAYER_SPD;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();

  // â”€â”€ BULLET MOVEMENT + COLLISION
  const deadBullets = [];
  S.bullets.forEach((b, bi) => {
    b.y -= DIFF.bulletSpd;
    b.el.style.top = b.y + 'px';

    if (b.y < -40) {
      // Miss â€” reset combo, streak, and feed streak
      deadBullets.push(bi); b.el.remove();
      clearTimeout(S.comboTimer);
      S.combo = 1; updateComboDisplay();
      S.streak = 0;
      S.feedStreak = 0;
      return;
    }

    for (const a of S.aliens) {
      if (!a.alive) continue;
      const hr = a.isBoss ? 65 : a.isMinion ? 45 : 38;
      if (Math.abs(b.x - a.x) < hr && Math.abs(b.y - a.y) < hr) {

        // â”€â”€ BOSS DODGE (phase 2, adults mode)
        if (a.isBoss && gameMode === 'adults' && S.bossPhase2 && Math.random() < 0.25) {
          a.vx += (Math.random() < 0.5 ? -1 : 1) * 38;
          dodgeEffect(a.x, a.y);
          continue; // bullet keeps flying past the boss
        }

        // â”€â”€ CONFIRMED HIT
        boom(a.x, a.y);
        S.shotsHit++;

        // Feed streak â€” consecutive hits without any miss or death
        S.feedStreak++;
        const FEED_MILESTONES = [[20, 500], [100, 2000], [200, 5000]];
        for (const [mark, pts] of FEED_MILESTONES) {
          if (S.feedStreak === mark && !S.feedMilestonesHit.has(mark)) {
            S.feedMilestonesHit.add(mark);
            S.score += pts;
            updateHUD();
            showGameToast(`ğŸ”¥ ${mark} IN A ROW! +${pts.toLocaleString()}`, '#ff6600');
          }
        }

        // Combo update
        clearTimeout(S.comboTimer);
        S.combo = Math.min(S.combo + 1, 8);
        updateComboDisplay();
        S.comboTimer = setTimeout(() => { S.combo = 1; updateComboDisplay(); }, COMBO_WINDOW);

        // Streak tracking â€” rapid consecutive hits
        const hitNow = performance.now();
        if (hitNow - S.streakLastHit <= STREAK_WINDOW) {
          S.streak++;
        } else {
          S.streak = 1;
        }
        S.streakLastHit = hitNow;
        // Award multi-feed charge at streak threshold
        if (S.streak > 0 && S.streak % STREAK_THRESHOLD === 0 && S.multiFeedCharge < MULTI_FEED_MAX) {
          S.multiFeedCharge++;
          sndStreak();
          updateMultiFeedDisplay();
          showGameToast('ğŸ• MULTI-FEED READY!', '#ffdd44');
        }

        deadBullets.push(bi);
        b.el.remove();

        if (a.isBoss) {
          sndBossHit();
          S.bossHp--;
          S.score += 20 * S.combo;
          // Grow the giraffe with each feeding
          a.size = (a.size || 100) + 8;
          if (a.el) a.el.style.fontSize = a.size + 'px';
          updateBossBar();
          // Phase 2 transition (adults only, at 50% HP)
          if (gameMode === 'adults' && !S.bossPhase2 && S.bossHp <= Math.floor(S.bossMaxHp * BOSS_PHASE2_PCT)) {
            activateBossPhase2(a);
          }
          if (S.bossHp <= 0) {
            a.alive = false;
            if (a.el) { a.el.remove(); a.el = null; }
            sndBossDefeat();
            // Clear any surviving minions when boss is defeated
            S.aliens.forEach(m => {
              if (m.isMinion && m.alive) {
                m.alive = false;
                if (m.el) { boom(m.x, m.y); m.el.remove(); m.el = null; }
              }
            });
          }
        } else if (a.isMinion) {
          sndHit();
          a.alive = false;
          if (a.el) { a.el.remove(); a.el = null; }
          S.score += 15 * S.combo;
        } else {
          sndHit();
          a.alive = false;
          a.el.remove(); a.el = null;
          S.score += 10 * S.combo;
        }
        updateHUD();
        break;
      }
    }
  });
  deadBullets.sort((a,b)=>b-a).forEach(i => S.bullets.splice(i,1));

  // â”€â”€ CHECK WAVE COMPLETE
  if (S.aliens.every(a => !a.alive)) { triggerWaveComplete(); return; }

  // â”€â”€ ALIEN MOVEMENT (speeds up as animals get close to player)
  const aliveNow = S.aliens.filter(a => a.alive);
  if (aliveNow.length > 0) {
    let minDist = Infinity;
    let touched = null;
    for (const a of aliveNow) {
      const dx = a.x - S.playerX, dy = a.y - S.playerY;
      const d = Math.sqrt(dx*dx + dy*dy);
      if (d < minDist) minDist = d;
      if (d < (a.isBoss ? 100 : 70)) touched = a;
    }
    // Animal reached the basket â€” it escapes (boss doesn't die from touching, only from being fed)
    if (touched) {
      if (!touched.isBoss) {
        touched.alive = false;
        if (touched.el) { touched.el.remove(); touched.el = null; }
      }
      loseLife();
      return;
    }
    const ratio = Math.min(1, minDist / (S.H * 0.55));
    const waveScale = Math.max(0.4, 1 - (S.wave - 1) * 0.12); // 12% faster per wave, min 40%
    S.moveMs = (DIFF.moveNear + ratio * (DIFF.moveFar - DIFF.moveNear)) * waveScale;
  }
  alienTimer += dt;
  if (alienTimer >= S.moveMs) {
    alienTimer = 0;
    stepAliens();
  }

  rafId = requestAnimationFrame(loop);
}

function stepAliens() {
  const alive = S.aliens.filter(a => a.alive);
  if (!alive.length) return;

  const pad = 50;

  alive.forEach(a => {
    const maxV = (a.isBoss && S.bossPhase2) ? 58 : DIFF.maxV;

    if (a.isMinion) {
      // Minions always aggressively chase the player
      const toX = S.playerX - a.x, toY = S.playerY - a.y;
      const dist = Math.sqrt(toX*toX + toY*toY) || 1;
      a.vx += (toX / dist) * 14;
      a.vy += (toY / dist) * 14;
    } else if (a.isBoss) {
      // Boss moves slower in easy, chases in adults
      if (gameMode === 'adults') {
        const toX = S.playerX - a.x, toY = S.playerY - a.y;
        const dist = Math.sqrt(toX*toX + toY*toY) || 1;
        const chaseStr = S.bossPhase2 ? (5 + S.wave * 0.9) : (2 + S.wave * 0.4);
        a.vx += (toX / dist) * chaseStr;
        a.vy += (toY / dist) * chaseStr;
        // Phase 2: random juke moves to dodge player shots
        if (S.bossPhase2 && Math.random() < 0.28) {
          a.vx += (Math.random() * 2 - 1) * 10;
          a.vy += (Math.random() * 2 - 1) * 7;
        }
      } else {
        if (Math.random() < 0.45) {
          a.vx += (Math.random() * 2 - 1) * 7;
          a.vy += (Math.random() * 2 - 1) * 5;
        }
      }
    } else if (gameMode === 'adults') {
      // Chase the player â€” steer velocity toward basket
      const toX = S.playerX - a.x, toY = S.playerY - a.y;
      const dist = Math.sqrt(toX*toX + toY*toY) || 1;
      const chase = 7 + S.wave * 1.5;
      a.vx += (toX / dist) * chase;
      a.vy += (toY / dist) * chase;
    } else {
      // Randomly nudge direction each step
      if (Math.random() < DIFF.changePct) {
        a.vx += (Math.random() * 2 - 1) * 18;
        a.vy += (Math.random() * 2 - 1) * 14;
      }
    }
    a.vx = Math.max(-maxV, Math.min(maxV, a.vx));
    a.vy = Math.max(-maxV, Math.min(maxV, a.vy));

    a.x += a.vx;
    a.y += a.vy;

    // Bounce off all four walls
    if (a.x < pad)       { a.x = pad;       a.vx =  Math.abs(a.vx); }
    if (a.x > S.W - pad) { a.x = S.W - pad; a.vx = -Math.abs(a.vx); }
    if (a.y < pad)       { a.y = pad;       a.vy =  Math.abs(a.vy); }
    if (a.y > S.H - pad) { a.y = S.H - pad; a.vy = -Math.abs(a.vy); }
  });

  syncAliens();

  // Hop animation (skip boss and minions â€” they have their own float animations)
  alive.forEach(a => {
    if (!a.el || a.isBoss || a.isMinion) return;
    a.el.classList.remove('hop');
    void a.el.offsetWidth;
    a.el.classList.add('hop');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIFE LOST / WIN / LOSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loseLife() {
  S.lives--;
  S.livesLostThisWave++;
  S.streak = 0; S.streakLastHit = 0;
  S.multiFeedCharge = 0; updateMultiFeedDisplay();
  S.feedStreak = 0;
  updateHUD();
  sndLifeLost();

  if (S.lives <= 0) {
    triggerLose();
  } else {
    // Flash screen red briefly, then reset alien positions
    document.getElementById('game-container').style.background = 'radial-gradient(ellipse at 50% 30%, #3a2800 0%, #1a1000 100%)';
    setTimeout(()=>{
      document.getElementById('game-container').style.background = 'radial-gradient(ellipse at 50% 30%, #2a0050 0%, #0d0030 40%, #000015 100%)';
    }, 400);

    // Reset player to bottom center
    S.playerX = S.W / 2;
    S.playerY = S.H - 70;
    syncPlayer();

    if (gameMode === 'adults') {
      // Kill remaining aliens, pause 2s, then respawn same wave (or boss)
      cancelAnimationFrame(rafId);
      S.aliens.forEach(a => { if (a.el) { a.el.remove(); a.el = null; } a.alive = false; });
      S.bullets.forEach(b => b.el.remove()); S.bullets = [];
      const wasBoss = S.isBossWave;
      S.isBossWave = false;
      hideBossBar();
      const msg = wasBoss ? 'ğŸ¦’ The giraffe is back!' : 'ğŸ˜¤ They\'re coming back!';
      showWaveBanner(`<div class="bt">${msg}</div><div class="bs">Get ready...</div>`, 2200)
        .then(() => wasBoss ? spawnBossWave() : spawnWaveAliens(false));
    } else if (S.isBossWave) {
      // Easy mode boss wave: pause, then respawn boss at full HP
      cancelAnimationFrame(rafId);
      S.aliens.forEach(a => { if (a.el) { a.el.remove(); a.el = null; } });
      S.bullets.forEach(b => b.el.remove()); S.bullets = [];
      S.isBossWave = false;
      hideBossBar();
      showWaveBanner(`<div class="bt">ğŸ¦’ The giraffe is hungry again!</div><div class="bs">Get ready...</div>`, 2200)
        .then(() => spawnBossWave());
    } else {
      resetAlienPositions();
    }
  }
}

function resetAlienPositions() {
  // Cancel animation loop briefly
  cancelAnimationFrame(rafId);

  const alive = S.aliens.filter(a=>a.alive);
  const marginX = Math.min(S.W * 0.12, 60);
  const spacing = (S.W - marginX*2) / (COLS - 1);

  // Re-number alive aliens left-to-right, top-to-bottom maintaining relative positions
  let col = 0, row = 0;
  alive.sort((a,b)=>{
    const aIdx = S.aliens.indexOf(a), bIdx = S.aliens.indexOf(b);
    return aIdx - bIdx;
  });
  alive.forEach((a,i) => {
    a.x = marginX + (i % COLS) * spacing;
    a.y = 55 + Math.floor(i / COLS) * Math.min(70, S.H * 0.11);
    a.vx = (Math.random() * 2 - 1) * DIFF.initVx;
    a.vy = (Math.random() * 2 - 1) * DIFF.initVy;
    if (a.el) { a.el.style.left = a.x+'px'; a.el.style.top = a.y+'px'; }
  });

  alienTimer = 0;
  lastTs = performance.now();
  rafId = requestAnimationFrame(loop);
}

function triggerWin() {
  S.won = true;
  cancelAnimationFrame(rafId);
  sndWin();
  const winH1 = document.querySelector('#win-screen h1');
  const winP  = document.querySelector('#win-screen p');
  if (gameMode === 'adults') {
    winH1.textContent = 'IMPRESSIVE! ğŸ’ªğŸ‰';
    winP.textContent  = 'You actually did it. Respect! ğŸ˜¤';
  } else {
    winH1.textContent = 'YAY THEO! ğŸ‰';
    winP.textContent  = 'All animals are fed! AMAZING!!';
  }
  document.getElementById('final-score').textContent = 'ğŸŒŸ Fed ' + S.score + ' animals! ğŸŒŸ';
  showScreen('win-screen');
  confetti();
}

function triggerLose() {
  S.gameOver = true;
  cancelAnimationFrame(rafId);
  sndLose();
  showScreen('lose-screen');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WAVE / COMBO HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showWaveBanner(html, duration) {
  const b = document.getElementById('wave-banner');
  b.innerHTML = html;
  b.classList.remove('visible');
  void b.offsetWidth;
  b.classList.add('visible');
  b.style.display = 'block';
  return new Promise(resolve => setTimeout(() => { b.style.display = 'none'; resolve(); }, duration));
}

function calcAccuracyBonus() {
  if (!S.shotsFired) return { pct: 100, bonus: 0, label: '' };
  const pct = Math.round(S.shotsHit / S.shotsFired * 100);
  const bonus = pct === 100 ? 200 : pct >= 90 ? 120 : pct >= 75 ? 60 : pct >= 50 ? 20 : 0;
  return { pct, bonus, label: `${pct}% accuracy` };
}

function spawnWaveAliens(advanceWave) {
  if (advanceWave) S.wave++;
  S.isBossWave = false;
  hideBossBar();
  // Reset per-wave stats
  S.shotsFired = 0; S.shotsHit = 0;
  S.combo = 1; clearTimeout(S.comboTimer); updateComboDisplay();
  S.streak = 0; S.streakLastHit = 0;
  S.multiFeedCharge = 0; updateMultiFeedDisplay();
  S.livesLostThisWave = 0;
  S.bullets.forEach(b => b.el.remove()); S.bullets = [];
  S.aliens.forEach(a => { if (a.el) { a.el.remove(); a.el = null; } });

  const area = document.getElementById('game-area');
  const W = S.W, H = S.H;
  const marginX = Math.min(W * 0.12, 60);
  const spacing  = (W - marginX * 2) / (COLS - 1);
  const rowH     = Math.min(70, H * 0.11);
  const speedScale = 1 + (S.wave - 1) * 0.18;

  S.aliens = [];
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const el = document.createElement('div');
      el.className = 'alien';
      el.textContent = ROW_EMOJIS[r][c];
      const x = marginX + c * spacing, y = 55 + r * rowH;
      el.style.left = x + 'px'; el.style.top = y + 'px';
      area.appendChild(el);
      S.aliens.push({
        x, y, emoji: ROW_EMOJIS[r][c], alive: true, el,
        vx: (Math.random() * 2 - 1) * DIFF.initVx * speedScale,
        vy: (Math.random() * 2 - 1) * DIFF.initVy * speedScale,
      });
    }
  }
  S.waveTimeLimit = getWaveTimeLimit(false);
  S.waveStartTime = performance.now();
  updateHUD();
  alienTimer = 0; lastTs = performance.now();
  rafId = requestAnimationFrame(loop);
}

async function triggerWaveComplete() {
  cancelAnimationFrame(rafId);

  // â”€â”€ No-death bonus helper
  const noDeathBonus = S.livesLostThisWave === 0
    ? (S.isBossWave ? (gameMode === 'adults' ? 1000 : 600) : (gameMode === 'adults' ? 400 : 200))
    : 0;

  // â”€â”€ Boss defeated path
  if (S.isBossWave) {
    const { bonus: tBonus, secs } = calcTimeBonus();
    S.isBossWave = false;
    hideBossBar();
    S.score += 300 + tBonus + noDeathBonus;
    updateHUD();
    sndBossDefeat();
    const bParts = ['+300 boss bonus!'];
    if (tBonus > 0)      bParts.push(`+${tBonus} speed bonus! (${secs}s left)`);
    if (noDeathBonus > 0) bParts.push(`+${noDeathBonus} flawless!`);
    await showWaveBanner(
      `<div class="bt">ğŸ¦’ BOSS DEFEATED! ğŸ‰</div><div class="bs">${bParts.join('  ')}</div>`, 2800
    );
    if (gameMode !== 'adults' && S.wave >= MAX_WAVES) { triggerWin(); return; }
    await showWaveBanner(
      `<div class="bt">ğŸŒŠ Wave ${S.wave + 1}${gameMode === 'adults' ? ' ğŸ’ª' : ''}!</div><div class="bs">Get ready...</div>`, 1600
    );
    spawnWaveAliens(true);
    return;
  }

  const { pct, bonus, label } = calcAccuracyBonus();
  const { bonus: tBonus, secs } = calcTimeBonus();
  if (bonus)        { S.score += bonus;        updateHUD(); }
  if (tBonus)       { S.score += tBonus;       updateHUD(); }
  if (noDeathBonus) { S.score += noDeathBonus; updateHUD(); }
  const parts = [];
  if (bonus)            parts.push(`+${bonus} accuracy!`);
  else if (label)       parts.push(label);
  if (tBonus > 0)       parts.push(`+${tBonus} speed bonus! (${secs}s left)`);
  if (noDeathBonus > 0) parts.push(`+${noDeathBonus} flawless!`);
  const bonusStr = parts.join('  ');

  await showWaveBanner(
    `<div class="bt">ğŸ‰ Wave ${S.wave} done!</div><div class="bs">${bonusStr}</div>`, 2200
  );

  // Win condition for easy modes
  if (gameMode !== 'adults' && S.wave >= MAX_WAVES) { triggerWin(); return; }

  // Boss wave trigger after BOSS_WAVE
  if (S.wave === BOSS_WAVE) {
    await showWaveBanner(
      `<div class="bt">ğŸ¦’ BOSS INCOMING!</div><div class="bs">Feed the giraffe until he's FULL!</div>`, 2800
    );
    spawnBossWave();
    return;
  }

  await showWaveBanner(
    `<div class="bt">ğŸŒŠ Wave ${S.wave + 1}${gameMode === 'adults' ? ' ğŸ’ª' : ''}!</div><div class="bs">Get ready...</div>`, 1600
  );
  spawnWaveAliens(true);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOSS HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showBossBar() { document.getElementById('boss-bar-wrap').style.display = 'block'; updateBossBar(); }
function hideBossBar() { document.getElementById('boss-bar-wrap').style.display = 'none'; }
function updateBossBar() {
  const pct = Math.round((1 - S.bossHp / S.bossMaxHp) * 100);
  document.getElementById('boss-bar-fill').style.width = pct + '%';
  const label = pct < 25 ? 'Ravenous!' : pct < 50 ? 'Still hungry...' : pct < 75 ? 'Getting full!' : pct < 100 ? 'Almost full!' : 'STUFFED!';
  const rage = S.bossPhase2 ? 'ğŸ’¢ ' : '';
  document.getElementById('boss-bar-label').textContent = `ğŸ¦’ ${rage}${label} (${pct}% full)`;
  if (S.bossPhase2) {
    document.getElementById('boss-bar-fill').style.background = 'linear-gradient(90deg,#cc0000,#ff4400,#ff8800)';
    document.getElementById('boss-bar-track').style.borderColor = '#ff3300';
  }
}

function activateBossPhase2(boss) {
  S.bossPhase2 = true;
  if (boss.el) boss.el.classList.add('phase2');
  // Speed surge â€” boss gets much faster
  boss.vx *= 1.7;
  boss.vy *= 1.7;
  sndBossEnrage();
  updateBossBar();
  spawnBossMinions();
  showGameToast('ğŸ¦’ğŸ’¢ GIRAFFE ENRAGED!', '#ff4444');
}

function spawnBossMinions() {
  if (S.bossMinionsSpawned) return;
  S.bossMinionsSpawned = true;
  const area = document.getElementById('game-area');
  const minionSize = Math.round(Math.min(S.W * 0.075, 52));
  const spawns = [
    { x: S.W * 0.2, y: S.H * 0.32, vx:  DIFF.initVx * 1.6, vy: DIFF.initVy * 1.4 },
    { x: S.W * 0.8, y: S.H * 0.32, vx: -DIFF.initVx * 1.6, vy: DIFF.initVy * 1.4 },
  ];
  spawns.forEach(sp => {
    const el = document.createElement('div');
    el.className = 'alien boss-minion';
    el.textContent = 'ğŸ¦’';
    el.style.left = sp.x + 'px';
    el.style.top  = sp.y + 'px';
    el.style.fontSize = minionSize + 'px';
    area.appendChild(el);
    S.aliens.push({
      x: sp.x, y: sp.y,
      emoji: 'ğŸ¦’', alive: true, el,
      isMinion: true,
      size: minionSize,
      vx: sp.vx, vy: sp.vy,
    });
  });
}

function spawnBossWave() {
  S.isBossWave = true;
  S.bossMaxHp  = (gameMode === 'adults') ? BOSS_HP_HARD : BOSS_HP_EASY;
  S.bossHp     = S.bossMaxHp;
  S.bossPhase2 = false;
  S.bossMinionsSpawned = false;
  S.shotsFired = 0; S.shotsHit = 0;
  S.combo = 1; clearTimeout(S.comboTimer); updateComboDisplay();
  S.streak = 0; S.streakLastHit = 0;
  S.multiFeedCharge = 0; updateMultiFeedDisplay();
  S.livesLostThisWave = 0;
  S.bullets.forEach(b => b.el.remove()); S.bullets = [];
  S.aliens.forEach(a => { if (a.el) { a.el.remove(); a.el = null; } });

  const area = document.getElementById('game-area');
  const x = S.W / 2, y = S.H * 0.22;
  const el = document.createElement('div');
  el.className = 'alien boss';
  el.textContent = 'ğŸ¦’';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  const bossBaseSize = Math.round(Math.min(S.W * 0.16, 110));
  el.style.fontSize = bossBaseSize + 'px';
  area.appendChild(el);

  const speedMult = gameMode === 'adults' ? 1.4 : 0.6;
  S.aliens = [{
    x, y,
    emoji: 'ğŸ¦’',
    alive: true,
    el,
    isBoss: true,
    size: bossBaseSize,
    vx: (Math.random() * 2 - 1) * DIFF.initVx * speedMult,
    vy: (Math.random() * 2 - 1) * DIFF.initVy * speedMult,
  }];

  S.waveTimeLimit = getWaveTimeLimit(true);
  S.waveStartTime = performance.now();
  showBossBar();
  updateHUD();
  alienTimer = 0; lastTs = performance.now();
  rafId = requestAnimationFrame(loop);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START / RESTART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startGame(mode) {
  if (mode) gameMode = mode;
  setDifficulty(gameMode);

  // Mode badge + lose screen flavour
  const badge = document.getElementById('mode-badge');
  if (gameMode === 'adults') {
    badge.textContent = 'ğŸ’ª HARD MODE';
    badge.style.color = '#ff6644';
    document.getElementById('lose-emoji').textContent = 'ğŸ˜‚';
    document.getElementById('lose-title').textContent = 'Too Slow!';
    document.getElementById('lose-msg').textContent = 'The animals outsmarted you! ğŸ¢ğŸ’¨';
  } else {
    badge.textContent = gameMode === 'friends' ? 'ğŸ‘« Theo\'s Friends' : 'ğŸ‘¦ Theo';
    badge.style.color = 'rgba(255,255,255,0.7)';
    document.getElementById('lose-emoji').textContent = 'ğŸ˜…';
    document.getElementById('lose-title').textContent = 'Try Again!';
    document.getElementById('lose-msg').textContent = 'The animals are still hungry! ğŸŸ';
  }

  cancelAnimationFrame(rafId);
  hideBossBar();
  showScreen(null);
  clearArea();
  makeStars();
  initState();
  makeAliens();
  syncPlayer();
  updateHUD();
  updateComboDisplay();
  updateMultiFeedDisplay();
  alienTimer = 0;
  lastTs = performance.now();
  rafId = requestAnimationFrame(loop);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
  keys[e.key] = true;
  if (e.key === ' ' || e.key === 'Spacebar') { e.preventDefault(); shoot(); }
  if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown',' '].includes(e.key)) e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.key] = false; });

const area = document.getElementById('game-area');

// Mouse
area.addEventListener('mousemove', e => {
  if (S.gameOver || S.won) return;
  const r = area.getBoundingClientRect();
  S.playerX = e.clientX - r.left;
  S.playerY = e.clientY - r.top;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();
});
area.addEventListener('click', e => {
  if (S.gameOver || S.won) return;
  shoot();
});

// Touch
area.addEventListener('touchstart', e => {
  e.preventDefault();
  if (S.gameOver || S.won) return;
  const t = e.touches[0];
  const r = area.getBoundingClientRect();
  S.playerX = t.clientX - r.left;
  S.playerY = t.clientY - r.top;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();
  shoot();
}, { passive: false });

area.addEventListener('touchmove', e => {
  e.preventDefault();
  if (S.gameOver || S.won) return;
  const t = e.touches[0];
  const r = area.getBoundingClientRect();
  S.playerX = t.clientX - r.left;
  S.playerY = t.clientY - r.top;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();
}, { passive: false });

// Resize
window.addEventListener('resize', () => {
  if (!S.W) return;
  const a = document.getElementById('game-area');
  S.W = a.clientWidth;
  S.H = a.clientHeight;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUPABASE / LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SB_URL = 'https://mrmilxmodbzipoxzobpc.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ybWlseG1vZGJ6aXBveHpvYnBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4OTU2NTEsImV4cCI6MjA4NzQ3MTY1MX0.eeahruUHXLI73oXxhF1TadeHjnnJgL5eHpHQQY5H8LU';
const SB_HEADERS = { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json' };

let pendingScore = 0;
let pendingMode  = 'theo';

async function saveScore(name, score, mode) {
  // Remove any existing entry for this name, then insert fresh
  await fetch(SB_URL + '/rest/v1/scores?name=eq.' + encodeURIComponent(name), {
    method: 'DELETE',
    headers: SB_HEADERS,
  }).catch(() => {});
  const res = await fetch(SB_URL + '/rest/v1/scores', {
    method: 'POST',
    headers: SB_HEADERS,
    body: JSON.stringify({ name, score, mode }),
  });
  if (!res.ok) throw new Error('Insert failed');
}

async function showNameEntry() {
  pendingScore = S.score || 0;
  pendingMode  = gameMode;
  if (gameMode === 'theo') {
    await saveScore('Theo', pendingScore, pendingMode).catch(() => {});
    showLeaderboard();
    return;
  }
  document.getElementById('name-score-display').textContent = 'ğŸŒŸ Score: ' + pendingScore;
  document.getElementById('name-error').textContent = '';
  document.getElementById('name-input').value = '';
  const btn = document.querySelector('#name-screen .play-btn');
  btn.textContent = 'ğŸ† Save!';
  btn.disabled = false;
  showScreen('name-screen');
  setTimeout(() => document.getElementById('name-input').focus(), 300);
}

async function submitScore() {
  const name = document.getElementById('name-input').value.trim();
  if (!name) {
    document.getElementById('name-error').textContent = 'Please enter your name!';
    return;
  }
  const btn = document.querySelector('#name-screen .play-btn');
  btn.textContent = 'Saving...';
  btn.disabled = true;
  try {
    await saveScore(name, pendingScore, pendingMode);
  } catch(e) {
    document.getElementById('name-error').textContent = 'Could not save â€” check your connection.';
    btn.textContent = 'ğŸ† Save!';
    btn.disabled = false;
    return;
  }
  showLeaderboard();
}

async function showLeaderboard() {
  showScreen('leaderboard-screen');
  document.getElementById('lb-loading').style.display = 'block';
  document.getElementById('lb-table').style.display  = 'none';
  try {
    const res = await fetch(
      SB_URL + '/rest/v1/scores?order=score.desc&limit=15&select=name,score,mode,created_at',
      { headers: SB_HEADERS }
    );
    if (!res.ok) throw new Error('Failed');
    const rows = await res.json();
    const body = document.getElementById('lb-body');
    body.innerHTML = '';
    const modeLabel = { theo: 'ğŸ‘¦', friends: 'ğŸ‘«', adults: 'ğŸ’ª' };
    rows.forEach((r, i) => {
      const date = new Date(r.created_at).toLocaleDateString();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] || (i+1)+'.'}</td><td>${r.name}</td><td>${r.score}</td><td>${modeLabel[r.mode] || r.mode}</td><td>${date}</td>`;
      body.appendChild(tr);
    });
    document.getElementById('lb-loading').style.display = 'none';
    document.getElementById('lb-table').style.display   = 'table';
  } catch(e) {
    document.getElementById('lb-loading').textContent = 'Could not load scores.';
  }
}

// Submit on Enter key in name input
document.getElementById('name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitScore();
});

function tapToStart() {
  unlockAudio();
  // Play a little jingle so they know audio is working
  setTimeout(() => { tone(523,'sine',0.15,0.3); }, 80);
  setTimeout(() => { tone(659,'sine',0.15,0.3); }, 200);
  setTimeout(() => { tone(784,'sine',0.2, 0.3); }, 320);
  showScreen('start-screen');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setDifficulty('theo');
makeStars();
showScreen('tap-screen');
</script>
</body>
</html>
