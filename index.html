<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Theo's Feeding Game! ğŸ§º</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  background: #000;
  font-family: 'Comic Sans MS', 'Chalkboard SE', 'Marker Felt', cursive;
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
}

/* â”€â”€ GAME CONTAINER â”€â”€ */
#game-container {
  position: relative;
  width: 100vw;
  height: 100vh;
  background: radial-gradient(ellipse at 50% 30%, #2a0050 0%, #0d0030 40%, #000015 100%);
  overflow: hidden;
}

/* â”€â”€ STARS â”€â”€ */
.star {
  position: absolute;
  background: white;
  border-radius: 50%;
  pointer-events: none;
  animation: twinkle var(--dur, 2s) ease-in-out infinite alternate;
}
@keyframes twinkle {
  from { opacity: 0.2; transform: scale(1); }
  to   { opacity: 1;   transform: scale(1.6); }
}

/* â”€â”€ TITLE â”€â”€ */
#title {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  font-size: clamp(22px, 5vw, 46px);
  white-space: nowrap;
  z-index: 10;
  animation: rainbow 3s linear infinite;
  -webkit-text-stroke: 2px rgba(0,0,0,0.4);
}
@keyframes rainbow {
  0%   { color: #ff4444; text-shadow: 0 0 20px #ff4444; }
  16%  { color: #ff9900; text-shadow: 0 0 20px #ff9900; }
  33%  { color: #ffff00; text-shadow: 0 0 20px #ffff00; }
  50%  { color: #44ff44; text-shadow: 0 0 20px #44ff44; }
  66%  { color: #44ffff; text-shadow: 0 0 20px #44ffff; }
  83%  { color: #ff44ff; text-shadow: 0 0 20px #ff44ff; }
  100% { color: #ff4444; text-shadow: 0 0 20px #ff4444; }
}

/* â”€â”€ HUD â”€â”€ */
#score-display {
  position: absolute;
  top: 65px;
  left: 50%;
  transform: translateX(-50%);
  font-size: clamp(18px, 3.5vw, 34px);
  color: #fff;
  text-shadow: 2px 2px 6px #000, 0 0 15px #FFD700;
  z-index: 10;
  white-space: nowrap;
}
#lives-display {
  position: absolute;
  top: 60px;
  right: 16px;
  font-size: clamp(22px, 4vw, 40px);
  z-index: 10;
  text-shadow: 0 0 10px rgba(255,200,100,0.8);
}

/* â”€â”€ GAME AREA â”€â”€ */
#game-area {
  position: absolute;
  top: 110px;
  left: 0; right: 0; bottom: 0;
}

/* â”€â”€ PLAYER â”€â”€ */
#player {
  position: absolute;
  font-size: clamp(38px, 7vw, 64px);
  transform: translateX(-50%) translateY(-50%);
  z-index: 10;
  filter: drop-shadow(0 0 12px rgba(100,220,255,0.9));
}

/* â”€â”€ FOOD (was bullets) â”€â”€ */
.bullet {
  position: absolute;
  font-size: clamp(26px, 4.5vw, 42px);
  z-index: 8;
  transform: translateX(-50%) translateY(-50%);
  pointer-events: none;
  line-height: 1;
  animation: food-spin 1.5s linear infinite;
  filter: drop-shadow(0 0 6px rgba(255,220,80,0.8));
}
@keyframes food-spin {
  from { transform: translateX(-50%) translateY(-50%) rotate(0deg) scale(1); }
  to   { transform: translateX(-50%) translateY(-50%) rotate(360deg) scale(1.1); }
}

/* â”€â”€ ALIENS â”€â”€ */
.alien {
  position: absolute;
  font-size: clamp(50px, 10vw, 90px);
  transform: translateX(-50%) translateY(-50%);
  z-index: 9;
  line-height: 1;
  filter: drop-shadow(0 0 8px rgba(255,220,100,0.6));
}
.alien.hop {
  animation: hop 0.15s ease-out;
}
@keyframes hop {
  0%   { transform: translateX(-50%) translateY(-50%) scale(1) rotate(0deg); }
  50%  { transform: translateX(-50%) translateY(-60%) scale(1.25) rotate(8deg); }
  100% { transform: translateX(-50%) translateY(-50%) scale(1) rotate(0deg); }
}

/* â”€â”€ NOM EFFECT (was explosions) â”€â”€ */
.explosion {
  position: absolute;
  pointer-events: none;
  z-index: 20;
  font-size: clamp(40px, 8vw, 70px);
  transform: translateX(-50%) translateY(-50%);
  animation: nom 0.65s ease-out forwards;
}
@keyframes nom {
  0%   { transform: translateX(-50%) translateY(-50%) scale(0.2) rotate(-10deg); opacity: 1; }
  40%  { transform: translateX(-50%) translateY(-65%) scale(1.7) rotate(10deg);  opacity: 1; }
  100% { transform: translateX(-50%) translateY(-90%) scale(1.2) rotate(0deg);   opacity: 0; }
}

/* â”€â”€ OVERLAY SCREENS â”€â”€ */
.screen {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  text-align: center;
  padding: 24px;
  gap: 16px;
}

#start-screen  { background: radial-gradient(ellipse at center, #1a0040 0%, #060018 100%); }
#win-screen    { background: radial-gradient(ellipse at center, #003318 0%, #001008 100%); display: none; }
#lose-screen   { background: radial-gradient(ellipse at center, #220000 0%, #080000 100%); display: none; }

.screen h1 {
  font-size: clamp(32px, 8vw, 76px);
  color: #FFD700;
  -webkit-text-stroke: 2px #FF4500;
  text-shadow: 3px 3px 0 #AA2200, 0 0 40px #FFD700;
  animation: bounce 0.7s ease-in-out infinite alternate;
}
@keyframes bounce {
  from { transform: translateY(0px) rotate(-1deg); }
  to   { transform: translateY(-18px) rotate(1deg); }
}

.screen p {
  font-size: clamp(18px, 3.5vw, 32px);
  color: #fff;
  text-shadow: 1px 1px 4px #000;
  line-height: 1.5;
}
.screen .subtitle {
  font-size: clamp(14px, 2.8vw, 26px);
  color: #aaffcc;
}

.big-emoji {
  font-size: clamp(56px, 12vw, 110px);
  animation: float-spin 2s ease-in-out infinite alternate;
  display: block;
  line-height: 1.2;
}
@keyframes float-spin {
  from { transform: rotate(-10deg) translateY(0px) scale(1); }
  to   { transform: rotate(10deg)  translateY(-22px) scale(1.05); }
}

.play-btn {
  font-size: clamp(22px, 4.5vw, 44px);
  padding: 18px 48px;
  background: linear-gradient(135deg, #FF5500, #FFD700);
  border: 4px solid #fff;
  border-radius: 60px;
  color: #fff;
  font-family: inherit;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(255,140,0,0.6), inset 0 2px 0 rgba(255,255,255,0.3);
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  animation: btn-pulse 1.4s ease-in-out infinite alternate;
  transition: transform 0.08s, box-shadow 0.08s;
}
.play-btn:hover, .play-btn:active {
  transform: scale(1.1) !important;
  box-shadow: 0 12px 36px rgba(255,140,0,0.8), inset 0 2px 0 rgba(255,255,255,0.3);
}
@keyframes btn-pulse {
  from { transform: scale(1); }
  to   { transform: scale(1.06); }
}

/* â”€â”€ CONFETTI â”€â”€ */
.confetti {
  position: fixed;
  width: 14px;
  height: 14px;
  border-radius: 3px;
  pointer-events: none;
  z-index: 200;
  animation: confetti-fall var(--dur,2s) var(--delay,0s) linear forwards;
}
@keyframes confetti-fall {
  0%   { transform: translateY(-20px) rotate(0deg)   scaleX(1);  opacity: 1; }
  50%  { scaleX(-1); }
  100% { transform: translateY(110vh) rotate(720deg) scaleX(1);  opacity: 0; }
}

/* â”€â”€ CONTROLS HINT â”€â”€ */
#hint {
  position: absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  font-size: clamp(10px, 1.8vw, 16px);
  color: rgba(255,255,255,0.35);
  z-index: 10;
  white-space: nowrap;
  pointer-events: none;
}
</style>
</head>
<body>

<!-- â•â•â•â• START SCREEN â•â•â•â• -->
<div class="screen" id="start-screen">
  <span class="big-emoji">ğŸ§º</span>
  <h1>THEO'S FEEDING GAME!</h1>
  <p>ğŸ¢ Turtles &amp; Fish are hungry! ğŸ </p>
  <p class="subtitle">Throw food to feed them all! ğŸ</p>
  <p class="subtitle" style="color:#ffdd88;">
    â† â†’ arrow keys or touch to move<br>
    SPACE or tap to throw food!
  </p>
  <button class="play-btn" onclick="startGame()">ğŸ§º LET'S FEED! ğŸ§º</button>
</div>

<!-- â•â•â•â• WIN SCREEN â•â•â•â• -->
<div class="screen" id="win-screen">
  <h1>YAY THEO! ğŸ‰</h1>
  <span class="big-emoji">ğŸ†</span>
  <p>All animals are fed! AMAZING!!</p>
  <p id="final-score" style="font-size: clamp(24px,5vw,50px); color:#FFD700; text-shadow:0 0 20px #FFD700;"></p>
  <button class="play-btn" onclick="startGame()">ğŸ§º FEED AGAIN! ğŸ§º</button>
</div>

<!-- â•â•â•â• LOSE SCREEN â•â•â•â• -->
<div class="screen" id="lose-screen">
  <span class="big-emoji">ğŸ˜…</span>
  <h1>Try Again!</h1>
  <p>The animals are still hungry, Theo! ğŸŸ</p>
  <button class="play-btn" onclick="startGame()">ğŸ§º TRY AGAIN! ğŸ§º</button>
</div>

<!-- â•â•â•â• GAME â•â•â•â• -->
<div id="game-container">
  <div id="title">ğŸ§º THEO'S FEEDING GAME! ğŸ§º</div>
  <div id="score-display">ğŸŒŸ Fed: 0</div>
  <div id="lives-display">ğŸ§ºğŸ§ºğŸ§º</div>
  <div id="game-area">
    <div id="player">ğŸ§º</div>
    <div id="hint">arrow keys or drag to move &nbsp;|&nbsp; SPACE or tap = throw food!</div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _ctx = null;
function ac() {
  if (!_ctx) _ctx = new (window.AudioContext || window.webkitAudioContext)();
  return _ctx;
}
function tone(freq, type, dur, vol, freqEnd) {
  try {
    const c = ac(), o = c.createOscillator(), g = c.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, c.currentTime);
    if (freqEnd) o.frequency.exponentialRampToValueAtTime(freqEnd, c.currentTime + dur);
    g.gain.setValueAtTime(vol, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, c.currentTime + dur);
    o.connect(g); g.connect(c.destination);
    o.start(); o.stop(c.currentTime + dur);
  } catch(e){}
}
function sndShoot()   { tone(500,'sine',0.06,0.2,900); setTimeout(()=>tone(700,'sine',0.08,0.15,1100),60); }
function sndHit()     { [880,1047,1319].forEach((n,i)=>setTimeout(()=>tone(n,'sine',0.18,0.3),i*60)); }
function sndLifeLost(){ tone(400,'sine',0.1,0.25,300); setTimeout(()=>tone(280,'sine',0.15,0.2,200),120); }
function sndWin() {
  [523,659,784,1047,1319].forEach((n,i)=>setTimeout(()=>tone(n,'sine',0.35,0.4),i*160));
  setTimeout(()=>[1568,1319,1047,784,1047,1319,1568].forEach((n,i)=>setTimeout(()=>tone(n,'triangle',0.25,0.35),i*120)),900);
}
function sndLose() { [380,300,240,180,130].forEach((n,i)=>setTimeout(()=>tone(n,'sawtooth',0.25,0.3),i*180)); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ROWS = 3;
const COLS = 7;
const MOVE_MS_START = 2000;  // ms between alien steps (gets faster over levels)
const BULLET_SPD  = 3;       // px/frame
const PLAYER_SPD  = 4;       // px/frame keyboard
const SHOOT_CD    = 900;     // ms cooldown between shots
const STEP_X      = 28;      // horizontal alien step
const STEP_Y      = 46;      // vertical alien step when bouncing wall

// emoji layout per row
const ROW_EMOJIS = [
  ['ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢','ğŸ¢'],
  ['ğŸ ','ğŸ¡','ğŸŸ','ğŸ ','ğŸ¡','ğŸŸ','ğŸ '],
  ['ğŸ¦‘','ğŸ™','ğŸ¦‘','ğŸ™','ğŸ¦‘','ğŸ™','ğŸ¦‘'],
];
const BOOM_EMOJIS  = ['â¤ï¸','ğŸ˜‹','ğŸ¥°','ğŸ˜Š','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ©·'];
const FOOD_EMOJIS  = ['ğŸ','ğŸ¥•','ğŸŸ','ğŸŒ¿','ğŸ“','ğŸ¥¦','ğŸ‡','ğŸŒ½'];
let foodIdx = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let S = {}; // game state
let rafId = null, lastTs = 0, alienTimer = 0;
const keys = {};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initState() {
  const area = document.getElementById('game-area');
  const W = area.clientWidth, H = area.clientHeight;

  // Build alien grid
  const aliens = [];
  const marginX = Math.min(W * 0.12, 60);
  const spacing = (W - marginX*2) / (COLS - 1);
  const startY  = 55;
  const rowH    = Math.min(70, H * 0.11);

  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      aliens.push({
        x:     marginX + c * spacing,
        y:     startY + r * rowH,
        emoji: ROW_EMOJIS[r][c],
        alive: true,
        el:    null,
        vx:    (Math.random() * 2 - 1) * 30,
        vy:    (Math.random() * 2 - 1) * 20,
      });
    }
  }

  S = {
    W, H,
    playerX:   W / 2,
    playerY:   H - 70,
    lives:     3,
    score:     0,
    aliens,
    bullets:   [],
    gameOver:  false,
    won:       false,
    lastShot:  0,
    moveMs:    MOVE_MS_START,
    level:     1,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearArea() {
  document.querySelectorAll('.alien,.bullet,.explosion,.confetti').forEach(e=>e.remove());
}

function makeAliens() {
  const area = document.getElementById('game-area');
  S.aliens.forEach(a => {
    const el = document.createElement('div');
    el.className = 'alien';
    el.textContent = a.emoji;
    el.style.left = a.x + 'px';
    el.style.top  = a.y + 'px';
    area.appendChild(el);
    a.el = el;
  });
}

function syncAliens() {
  S.aliens.forEach(a => {
    if (a.alive && a.el) {
      a.el.style.left = a.x + 'px';
      a.el.style.top  = a.y + 'px';
    }
  });
}

function syncPlayer() {
  const p = document.getElementById('player');
  p.style.left = S.playerX + 'px';
  p.style.top  = S.playerY + 'px';
}

function updateHUD() {
  document.getElementById('score-display').textContent = 'ğŸŒŸ Fed: ' + S.score;
  document.getElementById('lives-display').textContent = 'ğŸ§º'.repeat(Math.max(0, S.lives));
}

function showScreen(id) {
  ['start-screen','win-screen','lose-screen'].forEach(s=>{
    document.getElementById(s).style.display = (s===id) ? 'flex' : 'none';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EFFECTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function boom(x, y) {
  const area = document.getElementById('game-area');
  const el = document.createElement('div');
  el.className = 'explosion';
  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  el.textContent = BOOM_EMOJIS[Math.random()*BOOM_EMOJIS.length|0];
  area.appendChild(el);
  setTimeout(()=>el.remove(), 600);
}

function confetti() {
  const colors = ['#ff4444','#ff9900','#ffff00','#44ff44','#44ffff','#ff44ff','#ff88bb','#aaffaa'];
  for (let i = 0; i < 90; i++) {
    setTimeout(()=>{
      const el = document.createElement('div');
      el.className = 'confetti';
      el.style.left = (Math.random()*100) + 'vw';
      el.style.background = colors[Math.random()*colors.length|0];
      el.style.setProperty('--dur',  (1.4 + Math.random()*2.2)+'s');
      el.style.setProperty('--delay','0s');
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 4500);
    }, i * 40);
  }
}

function makeStars() {
  document.querySelectorAll('.star').forEach(s=>s.remove());
  const c = document.getElementById('game-container');
  for (let i = 0; i < 90; i++) {
    const el = document.createElement('div');
    el.className = 'star';
    const sz = Math.random()*2.5+0.8;
    el.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${1+Math.random()*2.5}s;animation-delay:${Math.random()*3}s`;
    c.appendChild(el);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function shoot() {
  if (S.gameOver || S.won) return;
  const now = performance.now();
  if (now - S.lastShot < SHOOT_CD) return;
  S.lastShot = now;

  const area = document.getElementById('game-area');
  const el = document.createElement('div');
  el.className = 'bullet';
  el.textContent = FOOD_EMOJIS[foodIdx % FOOD_EMOJIS.length];
  foodIdx++;
  const bx = S.playerX, by = S.playerY - 30;
  el.style.left = bx + 'px';
  el.style.top  = by + 'px';
  area.appendChild(el);
  S.bullets.push({ x: bx, y: by, el });
  sndShoot();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME LOOP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loop(ts) {
  if (S.gameOver || S.won) return;
  const dt = Math.min(ts - lastTs, 50); // cap dt so tabbing away doesn't cause issues
  lastTs = ts;

  // â”€â”€ PLAYER KEYBOARD MOVEMENT
  if (keys['ArrowLeft']  || keys['a'] || keys['A']) S.playerX -= PLAYER_SPD;
  if (keys['ArrowRight'] || keys['d'] || keys['D']) S.playerX += PLAYER_SPD;
  if (keys['ArrowUp']    || keys['w'] || keys['W']) S.playerY -= PLAYER_SPD;
  if (keys['ArrowDown']  || keys['s'] || keys['S']) S.playerY += PLAYER_SPD;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();

  // â”€â”€ BULLET MOVEMENT + COLLISION
  const deadBullets = [];
  S.bullets.forEach((b, bi) => {
    b.y -= BULLET_SPD;
    b.el.style.top = b.y + 'px';

    if (b.y < -40) { deadBullets.push(bi); b.el.remove(); return; }

    for (const a of S.aliens) {
      if (!a.alive) continue;
      if (Math.abs(b.x - a.x) < 38 && Math.abs(b.y - a.y) < 38) {
        // HIT!
        a.alive = false;
        a.el.remove(); a.el = null;
        boom(a.x, a.y);
        sndHit();
        S.score += 10;
        updateHUD();
        deadBullets.push(bi);
        b.el.remove();
        break;
      }
    }
  });
  deadBullets.sort((a,b)=>b-a).forEach(i => S.bullets.splice(i,1));

  // â”€â”€ CHECK WIN
  if (S.aliens.every(a => !a.alive)) { triggerWin(); return; }

  // â”€â”€ ALIEN MOVEMENT (speeds up as animals get close to player)
  const aliveNow = S.aliens.filter(a => a.alive);
  if (aliveNow.length > 0) {
    let minDist = Infinity;
    let touched = null;
    for (const a of aliveNow) {
      const dx = a.x - S.playerX, dy = a.y - S.playerY;
      const d = Math.sqrt(dx*dx + dy*dy);
      if (d < minDist) minDist = d;
      if (d < 70) touched = a;
    }
    // Animal reached the basket â€” it escapes
    if (touched) {
      touched.alive = false;
      if (touched.el) { touched.el.remove(); touched.el = null; }
      loseLife();
      return;
    }
    const ratio = Math.min(1, minDist / (S.H * 0.55));
    S.moveMs = 800 + ratio * 2200; // 800ms when close, 3000ms when far
  }
  alienTimer += dt;
  if (alienTimer >= S.moveMs) {
    alienTimer = 0;
    stepAliens();
  }

  rafId = requestAnimationFrame(loop);
}

function stepAliens() {
  const alive = S.aliens.filter(a => a.alive);
  if (!alive.length) return;

  const pad = 50;
  const maxV = 35;

  alive.forEach(a => {
    // Randomly nudge direction each step
    if (Math.random() < 0.35) {
      a.vx += (Math.random() * 2 - 1) * 18;
      a.vy += (Math.random() * 2 - 1) * 14;
      a.vx = Math.max(-maxV, Math.min(maxV, a.vx));
      a.vy = Math.max(-maxV, Math.min(maxV, a.vy));
    }

    a.x += a.vx;
    a.y += a.vy;

    // Bounce off all four walls
    if (a.x < pad)       { a.x = pad;       a.vx =  Math.abs(a.vx); }
    if (a.x > S.W - pad) { a.x = S.W - pad; a.vx = -Math.abs(a.vx); }
    if (a.y < pad)       { a.y = pad;       a.vy =  Math.abs(a.vy); }
    if (a.y > S.H - pad) { a.y = S.H - pad; a.vy = -Math.abs(a.vy); }
  });

  syncAliens();

  // Hop animation
  alive.forEach(a => {
    if (!a.el) return;
    a.el.classList.remove('hop');
    void a.el.offsetWidth;
    a.el.classList.add('hop');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIFE LOST / WIN / LOSE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loseLife() {
  S.lives--;
  updateHUD();
  sndLifeLost();

  if (S.lives <= 0) {
    triggerLose();
  } else {
    // Flash screen red briefly, then reset alien positions
    document.getElementById('game-container').style.background = 'radial-gradient(ellipse at 50% 30%, #3a2800 0%, #1a1000 100%)';
    setTimeout(()=>{
      document.getElementById('game-container').style.background = 'radial-gradient(ellipse at 50% 30%, #2a0050 0%, #0d0030 40%, #000015 100%)';
    }, 400);

    // Push aliens back to top
    resetAlienPositions();
  }
}

function resetAlienPositions() {
  // Cancel animation loop briefly
  cancelAnimationFrame(rafId);

  const alive = S.aliens.filter(a=>a.alive);
  const marginX = Math.min(S.W * 0.12, 60);
  const spacing = (S.W - marginX*2) / (COLS - 1);

  // Re-number alive aliens left-to-right, top-to-bottom maintaining relative positions
  let col = 0, row = 0;
  alive.sort((a,b)=>{
    const aIdx = S.aliens.indexOf(a), bIdx = S.aliens.indexOf(b);
    return aIdx - bIdx;
  });
  alive.forEach((a,i) => {
    a.x = marginX + (i % COLS) * spacing;
    a.y = 55 + Math.floor(i / COLS) * Math.min(70, S.H * 0.11);
    a.vx = (Math.random() * 2 - 1) * 30;
    a.vy = (Math.random() * 2 - 1) * 20;
    if (a.el) { a.el.style.left = a.x+'px'; a.el.style.top = a.y+'px'; }
  });

  alienTimer = 0;
  lastTs = performance.now();
  rafId = requestAnimationFrame(loop);
}

function triggerWin() {
  S.won = true;
  cancelAnimationFrame(rafId);
  sndWin();
  document.getElementById('final-score').textContent = 'ğŸŒŸ Fed ' + S.score + ' animals! ğŸŒŸ';
  showScreen('win-screen');
  confetti();
}

function triggerLose() {
  S.gameOver = true;
  cancelAnimationFrame(rafId);
  sndLose();
  showScreen('lose-screen');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   START / RESTART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startGame() {
  cancelAnimationFrame(rafId);
  showScreen(null);
  clearArea();
  makeStars();
  initState();
  makeAliens();
  syncPlayer();
  updateHUD();
  alienTimer = 0;
  lastTs = performance.now();
  rafId = requestAnimationFrame(loop);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
  keys[e.key] = true;
  if (e.key === ' ' || e.key === 'Spacebar') { e.preventDefault(); shoot(); }
  if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown',' '].includes(e.key)) e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.key] = false; });

const area = document.getElementById('game-area');

// Mouse
area.addEventListener('mousemove', e => {
  if (S.gameOver || S.won) return;
  const r = area.getBoundingClientRect();
  S.playerX = e.clientX - r.left;
  S.playerY = e.clientY - r.top;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();
});
area.addEventListener('click', e => {
  if (S.gameOver || S.won) return;
  shoot();
});

// Touch
area.addEventListener('touchstart', e => {
  e.preventDefault();
  if (S.gameOver || S.won) return;
  const t = e.touches[0];
  const r = area.getBoundingClientRect();
  S.playerX = t.clientX - r.left;
  S.playerY = t.clientY - r.top;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();
  shoot();
}, { passive: false });

area.addEventListener('touchmove', e => {
  e.preventDefault();
  if (S.gameOver || S.won) return;
  const t = e.touches[0];
  const r = area.getBoundingClientRect();
  S.playerX = t.clientX - r.left;
  S.playerY = t.clientY - r.top;
  S.playerX = Math.max(28, Math.min(S.W - 28, S.playerX));
  S.playerY = Math.max(28, Math.min(S.H - 28, S.playerY));
  syncPlayer();
}, { passive: false });

// Resize
window.addEventListener('resize', () => {
  if (!S.W) return;
  const a = document.getElementById('game-area');
  S.W = a.clientWidth;
  S.H = a.clientHeight;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
makeStars();
</script>
</body>
</html>
